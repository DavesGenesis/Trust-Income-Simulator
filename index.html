<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Income Simulation for TRUST</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Configure Tailwind for custom colors and font -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        // Light Theme Palette
                        'trust-navy': '#1e3a8a',    // Primary Accent (Dark Navy Blue)
                        'trust-gold': '#f59e0b',    // Secondary Accent (Gold)
                        'trust-green': '#059669',   // Success/FYC (Dark Green for contrast)
                        'trust-red': '#dc2626',     // Warning/Cost (Dark Red for contrast)
                        'trust-bg': '#f9fafb',      // Light Background (gray-50)
                        'trust-card': '#ffffff',    // White Card Background
                        'trust-input': '#f3f4f6',   // Light input background (gray-100)
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;400;700;900&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f9fafb; /* Light Background */
        }
        /* Custom scrollbar for aesthetics */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #e5e7eb; } /* Light Track */
        ::-webkit-scrollbar-thumb { background: #1e3a8a; border-radius: 4px; } /* Navy Thumb */
        ::-webkit-scrollbar-thumb:hover { background: #374151; }
        .input-label { color: #1f2937; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.25rem; }
        
        /* Custom Range Slider Styling */
        .slider::-webkit-slider-thumb {
            appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #1e3a8a;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .slider::-moz-range-thumb {
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #1e3a8a;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .slider::-webkit-slider-track {
            height: 8px;
            border-radius: 4px;
            background: linear-gradient(to right, #1e3a8a 0%, #1e3a8a var(--progress), #e5e7eb var(--progress), #e5e7eb 100%);
        }
        .slider::-moz-range-track {
            height: 8px;
            border-radius: 4px;
            background: #e5e7eb;
        }
    </style>
</head>
<body class="text-gray-700 min-h-screen">
    <div class="p-4 grid grid-cols-1 lg:grid-cols-[400px_1fr] gap-4">
        
        <!-- Control Panel (Left Side) -->
        <div class="bg-trust-card rounded-2xl p-6 overflow-y-auto flex flex-col gap-y-6 lg:h-screen lg:sticky lg:top-0 shadow-xl border border-gray-200">
            <div class="text-center">
                <div class="text-3xl font-extrabold text-gray-900">Income Simulation</div>
                <div class="text-sm text-trust-navy mt-1">TRUST Wealth Manager Commission Model</div>
            </div>

            <div class="space-y-6 flex-grow pb-10">
                
                <!-- Category 1: Initial Trust Setup -->
                <div class="bg-gray-50 p-4 rounded-xl space-y-4 border border-gray-200">
                    <h3 class="font-bold text-xl text-trust-gold border-b border-gray-300 pb-2">Initial Trust Setup</h3>
                    
                    <div class="space-y-3">
                        <label for="trustPrincipal" class="input-label">Trust Fund Principal (USD)</label>
                        <!-- Updated default value to $5,000,000 -->
                        <input type="text" id="trustPrincipal" class="form-input bg-white border border-gray-300 rounded-lg w-full p-2.5 text-gray-900 focus:ring-2 focus:ring-trust-navy" value="$5,000,000" min="1000000" step="100000" onfocus="parseCurrencyInput(this)" onblur="formatCurrencyInput(this)">
                    </div>

                    <div class="space-y-3">
                        <label for="settlorAge" class="input-label">Settlor/Grantor Age (Years)</label>
                        <input type="number" id="settlorAge" class="form-input bg-white border border-gray-300 rounded-lg w-full p-2.5 text-gray-900 focus:ring-2 focus:ring-trust-navy" value="50" min="18" max="100">
                    </div>

                    <div class="space-y-3">
                        <label for="initialBeneficiaries" class="input-label">Total Current Beneficiaries (Including Settlor)</label>
                        <!-- Updated default value to 5 -->
                        <input type="number" id="initialBeneficiaries" class="form-input bg-white border border-gray-300 rounded-lg w-full p-2.5 text-gray-900 focus:ring-2 focus:ring-trust-navy" value="5" min="1" max="10" oninput="renderBeneficiaries()">
                    </div>

                    <div class="space-y-3">
                        <label for="trustPeriod" class="input-label">Trust Period (Years)</label>
                        <div class="relative">
                            <input type="range" id="trustPeriod" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider" value="50" min="5" max="100" oninput="updateTrustPeriodDisplay()">
                            <div class="flex justify-between text-xs text-gray-500 mt-1">
                                <span>5</span>
                                <span id="trustPeriodValue" class="font-semibold text-trust-navy">5</span>
                                <span>100</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Dynamic Beneficiaries Data -->
                <div class="bg-gray-50 p-4 rounded-xl space-y-4 border border-gray-200" id="beneficiariesContainer">
                    <h3 class="font-bold text-xl text-trust-gold border-b border-gray-300 pb-2">Current Beneficiaries Data</h3>
                    <!-- Beneficiary cards will be rendered here -->
                </div>

                <!-- Category 2: Generation BluePrint -->
                <div class="bg-gray-50 p-4 rounded-xl space-y-4 border border-gray-200">
                    <h3 class="font-bold text-xl text-trust-gold border-b border-gray-300 pb-2">Generation BluePrint</h3>
                    
                    <div class="space-y-3">
                        <label for="marriageAge" class="input-label">Assumption Marriage Age of Descendant (Years)</label>
                        <input type="number" id="marriageAge" class="form-input bg-white border border-gray-300 rounded-lg w-full p-2.5 text-gray-900 focus:ring-2 focus:ring-trust-navy" value="28" min="18" max="50">
                    </div>

                    <div class="space-y-3">
                        <label for="childrenPerFamily" class="input-label">Children per Descendant Family</label>
                        <input type="number" id="childrenPerFamily" class="form-input bg-white border border-gray-300 rounded-lg w-full p-2.5 text-gray-900 focus:ring-2 focus:ring-trust-navy" value="2" min="1" max="5">
                    </div>

                    <!-- NEW INPUT: Distribution Rate -->
                     <div class="space-y-3">
                        <label for="distributionRate" class="input-label">Max Annual Distribution Rate (Net Income Profit)</label>
                        <!-- Using text input with % for clarity, parsing as number -->
                        <input type="text" id="distributionRate" class="form-input bg-white border border-gray-300 rounded-lg w-full p-2.5 text-gray-900 focus:ring-2 focus:ring-trust-navy" value="20%" onchange="updateDashboard()">
                    </div>
                </div>

                <!-- Category 3: Legacy Plan -->
                <div class="bg-gray-50 p-4 rounded-xl space-y-4 border border-gray-200">
                    <h3 class="font-bold text-xl text-trust-gold border-b border-gray-300 pb-2">Legacy Plan</h3>
                    <div class="space-y-3">
                        <label for="sumAssured" class="input-label">Sum Assured (SA) per Beneficiary (USD)</label>
                        <input type="text" id="sumAssured" class="form-input bg-white border border-gray-300 rounded-lg w-full p-2.5 text-gray-900 focus:ring-2 focus:ring-trust-navy" value="$1,000,000" min="1000000" step="100000" onfocus="parseCurrencyInput(this)" onblur="formatCurrencyInput(this)">
                    </div>
                </div>

                <!-- Info Box -->
                <div class="bg-trust-navy/10 border-l-4 border-trust-navy p-4 rounded-lg text-sm text-gray-800 space-y-2">
                    <p class="font-bold">Assumptions for Calculation:</p>
                    <ul class="list-disc list-inside space-y-1">
                        <li>All new insurance policies are Indexed Universal Life (IUL).</li>
                        <li>Target Yearly Net Income from Bond/Dividend is 5% p.a. of AUM.</li>
                    </ul>
                </div>
            </div>
            
            <button id="runSimulationBtn" class="w-full bg-trust-navy hover:bg-indigo-900 text-white font-extrabold py-3 rounded-xl shadow-lg transition-colors" onclick="updateDashboard()">
                Run Simulation (5 Years)
            </button>

        </div>

        <!-- Visualization Canvas (Right Side) -->
        <main class="flex-1 flex flex-col gap-y-6">
             <header class="bg-trust-card rounded-2xl p-6 shadow-xl border border-gray-200">
                <h1 class="text-3xl font-extrabold text-gray-900 text-center sm:text-left">WM Commission and Fund Projections</h1>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mt-4 text-center">
                    <!-- Metric 1: Total Beneficiaries -->
                    <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                        <div id="totalBeneficiariesTitle" class="text-sm font-semibold text-gray-500">Total Beneficiaries After 100 Years</div>
                        <div class="text-4xl font-extrabold text-trust-green mt-1" id="totalBeneficiaries">...</div>
                    </div>
                    <!-- Metric 2: Final Trust Fund AUM -->
                    <div class="bg-trust-navy/10 p-4 rounded-xl border border-trust-navy/30">
                        <div id="finalAUMTitle" class="text-sm font-semibold text-trust-navy">Final Trust Fund AUM (Year 100)</div>
                        <div class="text-4xl font-extrabold text-trust-navy mt-1" id="finalAUMDisplay">...</div>
                    </div>
                    <!-- MOVED METRIC: Total Distributed Income -->
                    <div class="bg-trust-gold/10 p-4 rounded-xl border border-trust-gold/30">
                        <div class="text-sm font-semibold text-gray-500">Total Income Distributed</div>
                        <div class="text-4xl font-extrabold text-trust-gold mt-1" id="totalDistribution">...</div>
                    </div>
                </div>
            </header>

            <!-- Visualization 1: Trust Fund Growth -->
            <div class="bg-trust-card rounded-2xl p-6 shadow-xl border border-gray-200">
                <h2 id="chartTitle" class="text-xl font-bold text-gray-900 border-b border-gray-300 pb-3 mb-4">üìà Trust Fund AUM Projection</h2>
                <div class="h-96"><canvas id="aumChart"></canvas></div>
            </div>

            <!-- Visualization 2: Potential Income for Wealth Manager (Summary Cards) -->
            <div class="bg-trust-card rounded-2xl p-6 shadow-xl border border-gray-200">
                <h2 id="potentialIncomeTitle" class="text-xl font-bold text-gray-900 border-b border-gray-300 pb-3 mb-4">üí∞ Potential Income for Wealth Manager (100-Year Total)</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    
                    <!-- TOTAL INCOME -->
                    <div class="col-span-full bg-trust-navy/90 p-6 rounded-xl shadow-2xl transform transition-all duration-300 hover:scale-[1.02]">
                        <div class="text-sm font-semibold text-white/90">TOTAL LIFETIME COMMISSION (USD)</div>
                        <div class="text-5xl font-black text-white mt-2" id="totalCommission">...</div>
                    </div>
                    
                    <!-- IUL FYC -->
                    <div class="bg-trust-green/10 border-l-4 border-trust-green p-4 rounded-xl shadow-md">
                        <div class="text-xs font-semibold text-trust-green">IUL First Year Commission (FYC)</div>
                        <div class="text-2xl font-bold text-gray-900 mt-1" id="fycCommission">...</div>
                        <p class="text-xs text-gray-500 mt-1">New Policies Sold: <span id="totalPolicies">0</span></p>
                    </div>

                    <!-- BOND BONUS -->
                    <div class="bg-trust-gold/10 border-l-4 border-trust-gold p-4 rounded-xl shadow-md">
                        <div class="text-xs font-semibold text-trust-gold">Bond/Performance Bonus (0.5% AUM)</div>
                        <div class="text-2xl font-bold text-gray-900 mt-1" id="bondCommission">...</div>
                        <p class="text-xs text-gray-500 mt-1">Paid Every 5 Years.</p>
                    </div>

                    <!-- MANAGEMENT FEE -->
                    <div class="bg-trust-navy/10 border-l-4 border-trust-navy p-4 rounded-xl shadow-md">
                        <div class="text-xs font-semibold text-trust-navy">Management Fee Commission (0.5% AUM)</div>
                        <div class="text-2xl font-bold text-gray-900 mt-1" id="mgmtCommission">...</div>
                        <p class="text-xs text-gray-500 mt-1">Paid Annually.</p>
                    </div>
                    
                    <!-- TOTAL PREMIUM -->
                    <div class="bg-trust-red/10 border-l-4 border-trust-red p-4 rounded-xl shadow-md">
                        <div class="text-xs font-semibold text-trust-red">Total IUL Premiums Paid by Trust</div>
                        <div class="text-2xl font-bold text-gray-900 mt-1" id="totalPremiumCost">...</div>
                        <p class="text-xs text-gray-500 mt-1">Over 100 Years.</p>
                    </div>
                    
                    <!-- TOTAL CLAIMS -->
                    <div class="bg-gray-500/10 border-l-4 border-gray-400 p-4 rounded-xl shadow-md">
                        <div class="text-xs font-semibold text-gray-500">Total Claims Added Back to AUM</div>
                        <div class="text-2xl font-bold text-gray-900 mt-1" id="totalClaimBenefit">...</div>
                        <p class="text-xs text-gray-500 mt-1">Boost from Legacy Plan.</p>
                    </div>
                    
                    <!-- NOTE: Total Distribution card REMOVED from here. -->

                </div>
            </div>
            
        </main>
    </div>

    <script>
        // Deterrent: Disable Right-Click (Context Menu)
        document.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            // Optional: You could show a custom message box here instead of just blocking
        });

        // Deterrent: Disable Keyboard Shortcuts (F12, Ctrl+Shift+I, etc.)
        document.addEventListener('keydown', (e) => {
            // F12 key check
            if (e.key === 'F12') {
                e.preventDefault();
            }
            // Ctrl+Shift+I (or Cmd+Option+I for Mac, though usually requires more complex key codes)
            if ((e.ctrlKey || e.metaKey) && e.shiftKey && (e.key === 'I' || e.key === 'i')) {
                e.preventDefault();
            }
        });

        let aumChart;
        let beneficiaries = [];
        const SA_TO_PREMIUM_RATIO = 10000 / 1000000; // 10k premium per 1M SA
        const PREMIUM_PAYMENT_YEARS = 10;
        const FYC_RATIO = 2000 / 10000; // $2000 commission per $10k premium
        const NET_GROWTH_RATE = 1.05; // 5% net annual growth
        const GROSS_INCOME_RATE = 0.08; // 8% gross income rate

        document.addEventListener('DOMContentLoaded', () => {
            // Set up initial beneficiaries data structure based on new requirements
            // This runs before renderBeneficiaries() which is called inside initializeCharts() or updateDashboard()
            beneficiaries = [
                { id: Date.now() + 1, name: "Settlor", relation: "Settlor", age: 50 },
                { id: Date.now() + 2, name: "Partner", relation: "Partner", age: 48 },
                { id: Date.now() + 3, name: "Child 1", relation: "Child", age: 20 },
                { id: Date.now() + 4, name: "Child 2", relation: "Child", age: 18 },
                { id: Date.now() + 5, name: "Child 3", relation: "Child", age: 16 },
            ];

            initializeCharts();
            renderBeneficiaries();
            // Format the currency inputs on initial load
            formatCurrencyInput(document.getElementById('trustPrincipal'));
            formatCurrencyInput(document.getElementById('sumAssured'));
            // Initialize Trust Period display
            updateTrustPeriodDisplay();
            // Initial calculation run
            setTimeout(updateDashboard, 100); 
        });
        
        // --- NEW CURRENCY INPUT HANDLERS ---

        function parseCurrency(value) {
            // Removes currency symbols, commas, and letters, returning a clean number.
            if (typeof value === 'string') {
                // Ensure only digits, potentially a leading minus sign, and decimal points remain
                const cleanValue = value.replace(/[^0-9.-]/g, '');
                return parseFloat(cleanValue) || 0;
            }
            return value || 0;
        }

        function parseCurrencyInput(input) {
            // When user focuses on input, show raw number for editing
            const rawValue = parseCurrency(input.value);
            input.value = rawValue.toString();
        }

        function formatCurrencyInput(input) {
            // When user leaves input, format as currency
            const rawValue = parseCurrency(input.value);
            input.value = formatCurrency(rawValue, false);
        }

        // --- BENEFICIARIES MANAGEMENT ---

        function renderBeneficiaries() {
            const container = document.getElementById('beneficiariesContainer');
            const count = parseInt(document.getElementById('initialBeneficiaries').value) || 5;
            
            // Adjust beneficiaries array to match count
            while (beneficiaries.length < count) {
                const newId = Date.now() + beneficiaries.length;
                beneficiaries.push({
                    id: newId,
                    name: `Person ${beneficiaries.length + 1}`,
                    relation: 'Child',
                    age: 18
                });
            }
            while (beneficiaries.length > count) {
                beneficiaries.pop();
            }

            // Clear existing content except title
            const title = container.querySelector('h3');
            container.innerHTML = '';
            container.appendChild(title);

            // Render beneficiary cards
            beneficiaries.forEach((beneficiary, index) => {
                const card = document.createElement('div');
                card.className = 'bg-white p-3 rounded-lg border border-gray-300 space-y-2';
                card.innerHTML = `
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="text-xs font-medium text-gray-600">Name</label>
                            <input type="text" value="${beneficiary.name}" 
                                   class="w-full text-sm p-1.5 border border-gray-300 rounded focus:ring-1 focus:ring-trust-navy"
                                   onchange="updateBeneficiary(${index}, 'name', this.value)">
                        </div>
                        <div>
                            <label class="text-xs font-medium text-gray-600">Relation</label>
                            <select class="w-full text-sm p-1.5 border border-gray-300 rounded focus:ring-1 focus:ring-trust-navy"
                                    onchange="updateBeneficiary(${index}, 'relation', this.value)">
                                <option value="Settlor" ${beneficiary.relation === 'Settlor' ? 'selected' : ''}>Settlor</option>
                                <option value="Partner" ${beneficiary.relation === 'Partner' ? 'selected' : ''}>Partner</option>
                                <option value="Child" ${beneficiary.relation === 'Child' ? 'selected' : ''}>Child</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="text-xs font-medium text-gray-600">Age (Years)</label>
                        <input type="number" value="${beneficiary.age}" min="0" max="100"
                               class="w-full text-sm p-1.5 border border-gray-300 rounded focus:ring-1 focus:ring-trust-navy"
                               onchange="updateBeneficiary(${index}, 'age', parseInt(this.value))">
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function updateBeneficiary(index, field, value) {
            if (beneficiaries[index]) {
                beneficiaries[index][field] = value;
            }
        }

        // --- TRUST PERIOD SLIDER FUNCTIONS ---

        function updateTrustPeriodDisplay() {
            const slider = document.getElementById('trustPeriod');
            const display = document.getElementById('trustPeriodValue');
            const button = document.getElementById('runSimulationBtn');
            const value = slider.value;
            display.textContent = value;
            
            // Update button text
            button.textContent = `Run Simulation (${value} Years)`;
            
            // Update slider progress bar
            const progress = ((value - slider.min) / (slider.max - slider.min)) * 100;
            slider.style.setProperty('--progress', progress + '%');
            
            // Force the slider value to be updated
            console.log(`Trust Period updated to: ${value} years`);
        }

        // --- CHART INITIALIZATION ---

        function initializeCharts() {
            const ctx = document.getElementById('aumChart').getContext('2d');
            aumChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array.from({ length: 101 }, (_, i) => i),
                    datasets: [{
                        label: 'Trust Fund AUM (USD)',
                        data: [],
                        borderColor: '#1e3a8a',
                        backgroundColor: 'rgba(30, 58, 138, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Years'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'AUM (USD)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value, true);
                                }
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }

        // --- SIMULATION ENGINE ---

        function runSimulation() {
            // Parse inputs
            const inputs = {
                trustPrincipal: parseCurrency(document.getElementById('trustPrincipal').value),
                settlorAge: parseInt(document.getElementById('settlorAge').value) || 50,
                marriageAge: parseInt(document.getElementById('marriageAge').value) || 28,
                childrenPerFamily: parseInt(document.getElementById('childrenPerFamily').value) || 2,
                sumAssured: parseCurrency(document.getElementById('sumAssured').value),
                distributionRate: parseFloat(document.getElementById('distributionRate').value.replace('%', '')) / 100 || 0.2,
                trustPeriod: parseInt(document.getElementById('trustPeriod').value) || 100
            };

            // Initialize simulation state
            let AUM = inputs.trustPrincipal;
            const AUM_VALUES = [AUM];
            
            // Commission tracking
            let totalFYC = 0;
            let totalBondCommission = 0;
            let totalMgmtCommission = 0;
            let totalPolicies = 0;
            let totalPremiumCost = 0;
            let totalClaimBenefit = 0;
            let totalDistributedIncome = 0;

            // Fund depletion tracking
            let fundDepleted = false;
            let depletionYear = 0;

            // Population tracking
            let currentBeneficiaries = beneficiaries.map(b => ({
                ...b,
                deathAge: 85,
                isAlive: true,
                hasPartner: b.relation === 'Settlor' || b.relation === 'Partner',
                // CORRECTED LOGIC: Only children start with policies
                policyYearsRemaining: b.relation === 'Child' ? PREMIUM_PAYMENT_YEARS : 0,
                childrenBorn: 0,
                yearMarried: b.relation === 'Settlor' || b.relation === 'Partner' ? 0 : -1,
                yearLastBirth: -1,
            }));

            // CORRECTED: Count initial policies only for children
            const initialChildren = currentBeneficiaries.filter(b => b.relation === 'Child');
            totalPolicies = initialChildren.length;

            let newBeneficiaryId = 1000;

            // Run simulation for the specified Trust Period
            for (let year = 1; year <= inputs.trustPeriod; year++) {
                const startingAUM = AUM;

                // --- FUND DEPLETION CHECK ---
                if (fundDepleted) {
                    // If fund is depleted, just maintain current AUM and continue aging population
                    // Filter out the dead for the next year
                    currentBeneficiaries = currentBeneficiaries.filter(b => b.isAlive);
                    
                    // Age everyone and handle deaths (but no new policies or premiums)
                    for (let i = 0; i < currentBeneficiaries.length; i++) {
                        const b = currentBeneficiaries[i];
                        b.age += 1;
                        if (b.age >= b.deathAge) {
                            b.isAlive = false;
                        }
                    }
                    
                    AUM_VALUES.push(AUM); // Maintain same AUM
                    continue;
                }

                // --- PRE-CALCULATE REQUIRED EXPENSES ---
                
                // Calculate potential premium payments for this year
                let potentialPremiumPayment = 0;
                currentBeneficiaries.forEach(b => {
                    if (b.isAlive && b.policyYearsRemaining > 0) {
                        potentialPremiumPayment += inputs.sumAssured * SA_TO_PREMIUM_RATIO;
                    }
                });

                // Calculate other required expenses
                const managementFeeDeduction = startingAUM * 0.005;
                const grossIncome = startingAUM * GROSS_INCOME_RATE;
                const netIncomeProfit = grossIncome - managementFeeDeduction;
                const potentialDistribution = netIncomeProfit * inputs.distributionRate;

                // Total required expenses this year
                const totalRequiredExpenses = potentialPremiumPayment + potentialDistribution + managementFeeDeduction;

                // Check if fund can cover all expenses
                if (startingAUM + grossIncome < totalRequiredExpenses) {
                    fundDepleted = true;
                    depletionYear = year;
                    
                    // Still age population but no financial transactions
                    currentBeneficiaries = currentBeneficiaries.filter(b => b.isAlive);
                    for (let i = 0; i < currentBeneficiaries.length; i++) {
                        const b = currentBeneficiaries[i];
                        b.age += 1;
                        if (b.age >= b.deathAge) {
                            b.isAlive = false;
                        }
                    }
                    
                    AUM_VALUES.push(startingAUM); // Freeze AUM at current level
                    continue;
                }

                // --- PROCEED WITH NORMAL OPERATIONS (Fund is sufficient) ---
                
                // --- 1. Commission Calculations ---
                
                // 1a. Management Fee Commission (0.5% of AUM, paid annually)
                const mgmtFee = startingAUM * 0.005;
                totalMgmtCommission += mgmtFee;
                
                // 1b. Bond/Performance Bonus (0.5% of AUM, paid every 5 years)
                if (year % 5 === 0) {
                    const bondBonus = startingAUM * 0.005;
                    totalBondCommission += bondBonus;
                }
                
                // --- 2. Trust Fund Growth & Distribution ---
                
                // 2d. Annual Distribution (% of Net Income Profit)
                const annualDistribution = netIncomeProfit * inputs.distributionRate;
                totalDistributedIncome += annualDistribution;
                
                // AUM adjusted for Management Fee and Distribution
                AUM = startingAUM + (netIncomeProfit - annualDistribution);
                
                // --- 3. Population Dynamics & Legacy Events ---
                
                // Filter out the dead for the next year
                currentBeneficiaries = currentBeneficiaries.filter(b => b.isAlive);
                
                let annualPremiumPayment = 0;
                let totalClaimReceived = 0;

                const beneficiariesToProcess = [...currentBeneficiaries]; 

                for (let i = 0; i < beneficiariesToProcess.length; i++) {
                    const b = beneficiariesToProcess[i];
                    
                    // --- A. Aging and Death ---
                    b.age += 1;
                    if (b.age >= b.deathAge) {
                        b.isAlive = false;
                        totalClaimReceived += inputs.sumAssured;
                        continue; 
                    }
                    
                    // --- B. Marriage and Partner Addition ---
                    if (!b.hasPartner && b.relation !== 'Settlor' && b.age === inputs.marriageAge) {
                        b.hasPartner = true;
                        b.yearMarried = year;
                        
                        // Add Partner
                        currentBeneficiaries.push({
                            id: newBeneficiaryId++,
                            name: `Partner of ${b.name}`,
                            relation: 'Partner',
                            age: inputs.marriageAge,
                            deathAge: 85,
                            isAlive: true,
                            isPartner: true,
                            hasPartner: true,
                            policyYearsRemaining: PREMIUM_PAYMENT_YEARS, // New Policy
                            childrenBorn: 0,
                            yearMarried: year,
                            yearLastBirth: -1,
                        });
                        // CORRECTED: Count new policy for partner
                        totalPolicies += 1;
                    }
                    
                    // --- C. Birth of Children ---
                    // FIXED: Only people who married during simulation (yearMarried > 0) can have children
                    // This prevents Settlor and Partner from having children
                    if (b.hasPartner && b.childrenBorn < inputs.childrenPerFamily && b.yearMarried > 0) {
                        const yearsSinceMarried = year - b.yearMarried;
                        const yearsSinceLastBirth = year - b.yearLastBirth;
                        
                        if ((b.childrenBorn === 0 && yearsSinceMarried === 1) || 
                            (b.childrenBorn > 0 && yearsSinceLastBirth === 2)) {
                            
                            b.childrenBorn += 1;
                            b.yearLastBirth = year;
                            
                            // Add Child
                            currentBeneficiaries.push({
                                id: newBeneficiaryId++,
                                name: `Child ${b.childrenBorn} of ${b.name}`,
                                relation: 'Child',
                                age: 0,
                                deathAge: 85,
                                isAlive: true,
                                isPartner: false,
                                hasPartner: false,
                                policyYearsRemaining: PREMIUM_PAYMENT_YEARS, // New Policy
                                childrenBorn: 0,
                                yearMarried: -1,
                                yearLastBirth: -1,
                            });
                            // CORRECTED: Count new policy for child
                            totalPolicies += 1;
                        }
                    }

                    // --- D. Policy Premium & Commission Tracking ---
                    if (b.policyYearsRemaining > 0) {
                        const annualPremium = inputs.sumAssured * SA_TO_PREMIUM_RATIO;
                        annualPremiumPayment += annualPremium;
                        
                        // 4a. IUL First Year Commission (FYC)
                        if (b.policyYearsRemaining === PREMIUM_PAYMENT_YEARS) {
                            const fyc = annualPremium * FYC_RATIO;
                            totalFYC += fyc;
                        }
                        b.policyYearsRemaining -= 1;
                    }
                }
                
                // --- 4. Final Trust Fund Value Update (AUM) ---
                
                // 3b. Fund Addition (Claims)
                AUM += totalClaimReceived;
                totalClaimBenefit += totalClaimReceived;

                // 3c. Fund Deduction (Premiums)
                AUM -= annualPremiumPayment;
                totalPremiumCost += annualPremiumPayment;
                
                // AUM growth already applied in step 2 via Net Income Profit calculation: AUM = startingAUM + (netIncomeProfit - annualDistribution);
                
                AUM_VALUES.push(Math.max(0, AUM));
            }

            return {
                AUM_VALUES,
                totalFYC,
                totalBondCommission,
                totalMgmtCommission,
                totalPolicies,
                totalPremiumCost,
                totalClaimBenefit,
                totalDistributedIncome,
                finalBeneficiaryCount: currentBeneficiaries.filter(b => b.isAlive).length,
                fundDepleted,
                depletionYear
            };
        }

        // --- DASHBOARD UPDATE & UTILITY FUNCTIONS ---
        
        function updateDashboard() {
            const results = runSimulation();
            
            // 1. Update Chart
            aumChart.data.labels = Array.from({ length: results.AUM_VALUES.length }, (_, i) => i);
            aumChart.data.datasets[0].data = results.AUM_VALUES;
            aumChart.update();
            
            // 2. Update Headline & Cards
            const totalCommission = results.totalFYC + results.totalBondCommission + results.totalMgmtCommission;
            
            // Update the key header displays
            const finalAUM = results.AUM_VALUES[results.AUM_VALUES.length - 1];
            document.getElementById('finalAUMDisplay').textContent = formatCurrency(finalAUM, false);
            document.getElementById('totalDistribution').textContent = formatCurrency(results.totalDistributedIncome, false);

            document.getElementById('totalBeneficiaries').textContent = results.finalBeneficiaryCount;
            document.getElementById('totalCommission').textContent = formatCurrency(totalCommission, false);
            document.getElementById('fycCommission').textContent = formatCurrency(results.totalFYC, false);
            document.getElementById('bondCommission').textContent = formatCurrency(results.totalBondCommission, false);
            document.getElementById('mgmtCommission').textContent = formatCurrency(results.totalMgmtCommission, false);
            document.getElementById('totalPolicies').textContent = results.totalPolicies;
            document.getElementById('totalPremiumCost').textContent = formatCurrency(results.totalPremiumCost, true);
            document.getElementById('totalClaimBenefit').textContent = formatCurrency(results.totalClaimBenefit, true);
            
            // 3. Update Fund Depletion Warning and Period Display
            const headerElement = document.querySelector('header h1');
            const chartTitleElement = document.getElementById('chartTitle');
            const totalBeneficiariesTitleElement = document.getElementById('totalBeneficiariesTitle');
            const finalAUMTitleElement = document.getElementById('finalAUMTitle');
            const potentialIncomeTitleElement = document.getElementById('potentialIncomeTitle');
            const trustPeriod = parseInt(document.getElementById('trustPeriod').value) || 100;
            
            // Update all dynamic titles
            chartTitleElement.textContent = `üìà Trust Fund AUM Projection (${trustPeriod} Years)`;
            totalBeneficiariesTitleElement.textContent = `Total Beneficiaries After ${trustPeriod} Years`;
            finalAUMTitleElement.textContent = `Final Trust Fund AUM (Year ${trustPeriod})`;
            potentialIncomeTitleElement.textContent = `üí∞ Potential Income for Wealth Manager (${trustPeriod}-Year Total)`;
            
            if (results.fundDepleted) {
                headerElement.innerHTML = `
                    WM Commission and Fund Projections (${trustPeriod}-Year Period)
                    <span class="text-red-600 text-lg font-bold block mt-2">
                        ‚ö†Ô∏è FUND DEPLETED IN YEAR ${results.depletionYear} - Simulation Stopped
                    </span>
                `;
                headerElement.className = 'text-3xl font-extrabold text-gray-900 text-center sm:text-left';
            } else {
                headerElement.innerHTML = `WM Commission and Fund Projections (${trustPeriod}-Year Period)`;
                headerElement.className = 'text-3xl font-extrabold text-gray-900 text-center sm:text-left';
            }
        }

        // Helper function for currency formatting (based on prior context)
        function formatCurrency(value, compact = false) {
            if (typeof value !== 'number' || isNaN(value)) value = 0;
            const displayValue = value;
            const symbol = '$';

            if (compact) {
                if (Math.abs(displayValue) >= 1e12) return `${symbol}${(displayValue / 1e12).toFixed(2)}T`;
                if (Math.abs(displayValue) >= 1e9) return `${symbol}${(displayValue / 1e9).toFixed(2)}B`;
                if (Math.abs(displayValue) >= 1e6) return `${symbol}${(displayValue / 1e6).toFixed(2)}M`;
                if (Math.abs(displayValue) >= 1e3) return `${symbol}${Math.round(displayValue / 1e3)}K`;
                return `${symbol}${displayValue.toLocaleString('en-US', { maximumFractionDigits: 0 })}`;
            }
            return symbol + displayValue.toLocaleString('en-US', { maximumFractionDigits: 0 });
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Income Simulation for TRUST</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Configure Tailwind for custom colors and font -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        // Light Theme Palette
                        'trust-navy': '#1e3a8a',
                        'trust-gold': '#f59e0b',
                        'trust-green': '#059669',
                        'trust-red': '#dc2626',
                        'trust-bg': '#f9fafb',
                        'trust-card': '#ffffff',
                        'trust-input': '#f3f4f6',
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;400;700;900&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f9fafb;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #e5e7eb; }
        ::-webkit-scrollbar-thumb { background: #1e3a8a; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #374151; }
        .input-label { color: #1f2937; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.25rem; }
        
        /* Custom slider styling for progress effect */
        .slider::-webkit-slider-thumb {
            appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #1e3a8a;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .slider::-moz-range-thumb {
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #1e3a8a;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .slider::-webkit-slider-track {
            height: 8px;
            border-radius: 4px;
            background: linear-gradient(to right, #1e3a8a 0%, #1e3a8a var(--progress), #e5e7eb var(--progress), #e5e7eb 100%);
        }
        .slider::-moz-range-track {
            height: 8px;
            border-radius: 4px;
            background: #e5e7eb;
        }
    </style>
</head>
<body class="text-gray-700 min-h-screen">
    <div class="p-4 grid grid-cols-1 lg:grid-cols-[400px_1fr] gap-4">
        
        <!-- Control Panel (Left Side) -->
        <div class="bg-trust-card rounded-2xl p-6 overflow-y-auto flex flex-col gap-y-6 lg:h-screen lg:sticky lg:top-0 shadow-xl border border-gray-200">
            <div class="text-center">
                <div class="text-3xl font-extrabold text-gray-900">Income Simulation</div>
                <div class="text-sm text-trust-navy mt-1">TRUST Wealth Manager Commission Model</div>
            </div>

            <div class="space-y-6 flex-grow pb-10">
                
                <!-- Category 1: Initial Trust Setup -->
                <div class="bg-gray-50 p-4 rounded-xl space-y-4 border border-gray-200">
                    <h3 class="font-bold text-xl text-trust-gold border-b border-gray-300 pb-2">Initial Trust Setup</h3>
                    
                    <div class="space-y-3">
                        <label for="trustPrincipal" class="input-label">Trust Fund Principal (USD)</label>
                        <input type="text" id="trustPrincipal" class="form-input bg-white border border-gray-300 rounded-lg w-full p-2.5 text-gray-900 focus:ring-2 focus:ring-trust-navy" value="$5,000,000" min="1000000" step="100000" onfocus="parseCurrencyInput(this)" onblur="formatCurrencyInput(this)">
                    </div>

                    <div class="space-y-3">
                        <label for="settlorAge" class="input-label">Settlor/Grantor Age (Years)</label>
                        <input type="number" id="settlorAge" class="form-input bg-white border border-gray-300 rounded-lg w-full p-2.5 text-gray-900 focus:ring-2 focus:ring-trust-navy" value="50" min="18" max="100">
                    </div>

                    <div class="space-y-3">
                        <label for="initialBeneficiaries" class="input-label">Total Current Beneficiaries (Including Settlor)</label>
                        <input type="number" id="initialBeneficiaries" class="form-input bg-white border border-gray-300 rounded-lg w-full p-2.5 text-gray-900 focus:ring-2 focus:ring-trust-navy" value="5" min="1" max="10" oninput="renderBeneficiaries()">
                    </div>

                    <div class="space-y-3">
                        <label for="trustPeriod" class="input-label">Trust Period (Years)</label>
                        <div class="relative">
                            <input type="range" id="trustPeriod" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider" value="50" min="5" max="100" oninput="updateTrustPeriodDisplay()">
                            <div class="flex justify-between text-xs text-gray-500 mt-1">
                                <span>5</span>
                                <span id="trustPeriodValue" class="font-semibold text-trust-navy">50</span>
                                <span>100</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Dynamic Beneficiaries Data -->
                <div class="bg-gray-50 p-4 rounded-xl space-y-4 border border-gray-200" id="beneficiariesContainer">
                    <h3 class="font-bold text-xl text-trust-gold border-b border-gray-300 pb-2">Current Beneficiaries Data</h3>
                </div>

                <!-- Category 2: Generation BluePrint -->
                <div class="bg-gray-50 p-4 rounded-xl space-y-4 border border-gray-200">
                    <h3 class="font-bold text-xl text-trust-gold border-b border-gray-300 pb-2">Generation BluePrint</h3>
                    
                    <div class="space-y-3">
                        <label for="marriageAge" class="input-label">Assumption Marriage Age of Descendant (Years)</label>
                        <input type="number" id="marriageAge" class="form-input bg-white border border-gray-300 rounded-lg w-full p-2.5 text-gray-900 focus:ring-2 focus:ring-trust-navy" value="28" min="18" max="50">
                    </div>

                    <div class="space-y-3">
                        <label for="childrenPerFamily" class="input-label">Children per Descendant Family</label>
                        <input type="number" id="childrenPerFamily" class="form-input bg-white border border-gray-300 rounded-lg w-full p-2.5 text-gray-900 focus:ring-2 focus:ring-trust-navy" value="2" min="1" max="5">
                    </div>

                    <div class="space-y-3">
                        <label for="distributionRate" class="input-label">Max Annual Distribution Rate (Net Income Profit)</label>
                        <input type="text" id="distributionRate" class="form-input bg-white border border-gray-300 rounded-lg w-full p-2.5 text-gray-900 focus:ring-2 focus:ring-trust-navy" value="20%" onchange="updateDashboard()">
                    </div>
                </div>

                <!-- Category 3: Legacy Plan -->
                <div class="bg-gray-50 p-4 rounded-xl space-y-4 border border-gray-200">
                    <h3 class="font-bold text-xl text-trust-gold border-b border-gray-300 pb-2">Legacy Plan</h3>
                    <div class="space-y-3">
                        <label for="sumAssured" class="input-label">Sum Assured (SA) per Beneficiary (USD)</label>
                        <input type="text" id="sumAssured" class="form-input bg-white border border-gray-300 rounded-lg w-full p-2.5 text-gray-900 focus:ring-2 focus:ring-trust-navy" value="$1,000,000" min="1000000" step="100000" onfocus="parseCurrencyInput(this)" onblur="formatCurrencyInput(this)">
                    </div>
                </div>

                <!-- Info Box -->
                <div class="bg-trust-navy/10 border-l-4 border-trust-navy p-4 rounded-lg text-sm text-gray-800 space-y-2">
                    <p class="font-bold">Assumptions for Calculation:</p>
                    <ul class="list-disc list-inside space-y-1">
                        <li>All new insurance policies are Indexed Universal Life (IUL).</li>
                        <li>Target Yearly Net Income from Bond/Dividend is 5% p.a. of AUM.</li>
                    </ul>
                </div>
            </div>
            
            <button id="runSimulationBtn" class="w-full bg-trust-navy hover:bg-indigo-900 text-white font-extrabold py-3 rounded-xl shadow-lg transition-colors" onclick="updateDashboard()">
                Run Simulation (50 Years)
            </button>

        </div>

        <!-- Visualization Canvas (Right Side) -->
        <main class="flex-1 flex flex-col gap-y-6">
             <header class="bg-trust-card rounded-2xl p-6 shadow-xl border border-gray-200">
                <h1 class="text-3xl font-extrabold text-gray-900 text-center sm:text-left">WM Commission and Fund Projections</h1>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mt-4 text-center">
                    <!-- Metric 1: Total Beneficiaries -->
                    <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                        <div id="totalBeneficiariesTitle" class="text-sm font-semibold text-gray-500">Total Beneficiaries After 50 Years</div>
                        <div class="text-4xl font-extrabold text-trust-green mt-1" id="totalBeneficiaries">...</div>
                    </div>
                    <!-- Metric 2: Final Trust Fund AUM -->
                    <div class="bg-trust-navy/10 p-4 rounded-xl border border-trust-navy/30">
                        <div id="finalAUMTitle" class="text-sm font-semibold text-trust-navy">Final Trust Fund AUM (Year 50)</div>
                        <div class="text-4xl font-extrabold text-trust-navy mt-1" id="finalAUMDisplay">...</div>
                    </div>
                    <!-- Metric 3: Total Distributed Income -->
                    <div class="bg-trust-gold/10 p-4 rounded-xl border border-trust-gold/30">
                        <div class="text-sm font-semibold text-gray-500">Total Income Distributed</div>
                        <div class="text-4xl font-extrabold text-trust-gold mt-1" id="totalDistribution">...</div>
                    </div>
                </div>
            </header>

            <!-- Visualization 1: Trust Fund Growth -->
            <div class="bg-trust-card rounded-2xl p-6 shadow-xl border border-gray-200">
                <h2 id="chartTitle" class="text-xl font-bold text-gray-900 border-b border-gray-300 pb-3 mb-4">📈 Trust Fund AUM Projection</h2>
                <div class="h-96"><canvas id="aumChart"></canvas></div>
            </div>

            <!-- Visualization 2: Potential Income for Wealth Manager -->
            <div class="bg-trust-card rounded-2xl p-6 shadow-xl border border-gray-200">
                <h2 id="potentialIncomeTitle" class="text-xl font-bold text-gray-900 border-b border-gray-300 pb-3 mb-4">💰 Potential Income for Wealth Manager (50-Year Total)</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    
                    <!-- TOTAL INCOME -->
                    <div class="col-span-full bg-trust-navy/90 p-6 rounded-xl shadow-2xl transform transition-all duration-300 hover:scale-[1.02]">
                        <div class="text-sm font-semibold text-white/90">TOTAL LIFETIME COMMISSION (USD)</div>
                        <div class="text-5xl font-black text-white mt-2" id="totalCommission">...</div>
                    </div>
                    
                    <!-- IUL FYC -->
                    <div class="bg-trust-green/10 border-l-4 border-trust-green p-4 rounded-xl shadow-md">
                        <div class="text-xs font-semibold text-trust-green">Total Insurance First Year Commission (FYC)</div>
                        <div class="text-2xl font-bold text-gray-900 mt-1" id="fycCommission">...</div>
                        <p class="text-xs text-gray-500 mt-1">New Policies Sold: <span id="totalPolicies">0</span></p>
                    </div>

                    <!-- BOND BONUS -->
                    <div class="bg-trust-gold/10 border-l-4 border-trust-gold p-4 rounded-xl shadow-md">
                        <div class="text-xs font-semibold text-trust-gold">Total Investment Commission(<span id="bondCommissionRate">0.15%</span> AUM)</div>
                        <div class="text-2xl font-bold text-gray-900 mt-1" id="bondCommission">...</div>
                        <p class="text-xs text-gray-500 mt-1">Paid Every 5 Years.</p>
                    </div>

                    <!-- MANAGEMENT FEE -->
                    <div class="bg-trust-navy/10 border-l-4 border-trust-navy p-4 rounded-xl shadow-md">
                        <div class="text-xs font-semibold text-trust-navy">Total Management Fee Commission (<span id="mgmtCommissionRate">0.15%</span> AUM)</div>
                        <div class="text-2xl font-bold text-gray-900 mt-1" id="mgmtCommission">...</div>
                        <p class="text-xs text-gray-500 mt-1">Paid Annually.</p>
                    </div>
                    
                    <!-- TOTAL PREMIUM -->
                    <div class="bg-trust-red/10 border-l-4 border-trust-red p-4 rounded-xl shadow-md">
                        <div class="text-xs font-semibold text-trust-red">Total IUL Premiums Paid by Trust</div>
                        <div class="text-2xl font-bold text-gray-900 mt-1" id="totalPremiumCost">...</div>
                        <p class="text-xs text-gray-500 mt-1">Over Selected Period.</p>
                    </div>
                    
                    <!-- TOTAL CLAIMS -->
                    <div class="bg-gray-500/10 border-l-4 border-gray-400 p-4 rounded-xl shadow-md">
                        <div class="text-xs font-semibold text-gray-500">Total Claims Added Back to AUM</div>
                        <div class="text-2xl font-bold text-gray-900 mt-1" id="totalClaimBenefit">...</div>
                        <p class="text-xs text-gray-500 mt-1">Boost from Legacy Plan.</p>
                    </div>

                </div>
            </div>
            
        </main>
    </div>

    <script>
        document.addEventListener('contextmenu', (e) => e.preventDefault());
        document.addEventListener('keydown', (e) => {
            if (e.key === 'F12' || ((e.ctrlKey || e.metaKey) && e.shiftKey && (e.key === 'I' || e.key === 'i'))) {
                e.preventDefault();
            }
        });

        let aumChart;
        let beneficiaries = [];
        const SA_TO_PREMIUM_RATIO = 10000 / 1000000;
        const PREMIUM_PAYMENT_YEARS = 10;
        const FYC_RATIO = 2000 / 10000;
        const NET_GROWTH_RATE = 1.05;
        const GROSS_INCOME_RATE = 0.08;
        const BOND_COMMISSION_RATE = 0.0015;
        const MGMT_COMMISSION_RATE = 0.0015;

        document.addEventListener('DOMContentLoaded', () => {
            beneficiaries = [
                { id: Date.now() + 1, name: "Settlor", relation: "Settlor", age: 50 },
                { id: Date.now() + 2, name: "Partner", relation: "Partner", age: 48 },
                { id: Date.now() + 3, name: "Child 1", relation: "Child", age: 20 },
                { id: Date.now() + 4, name: "Child 2", relation: "Child", age: 18 },
                { id: Date.now() + 5, name: "Child 3", relation: "Child", age: 16 },
            ];

            initializeCharts();
            renderBeneficiaries();
            formatCurrencyInput(document.getElementById('trustPrincipal'));
            formatCurrencyInput(document.getElementById('sumAssured'));
            updateTrustPeriodDisplay();
            document.getElementById('bondCommissionRate').textContent = `${(BOND_COMMISSION_RATE * 100).toFixed(2)}%`;
            document.getElementById('mgmtCommissionRate').textContent = `${(MGMT_COMMISSION_RATE * 100).toFixed(2)}%`;

            setTimeout(updateDashboard, 100); 
        });
        
        function parseCurrency(value) {
            if (typeof value === 'string') {
                const cleanValue = value.replace(/[^0-9.-]/g, '');
                return parseFloat(cleanValue) || 0;
            }
            return value || 0;
        }

        function parseCurrencyInput(input) {
            const rawValue = parseCurrency(input.value);
            input.value = rawValue.toString();
        }

        function formatCurrencyInput(input) {
            const rawValue = parseCurrency(input.value);
            input.value = formatCurrency(rawValue, false);
            updateDashboard();
        }

        function updateBeneficiary(index, field, value) {
            if (beneficiaries[index]) {
                beneficiaries[index][field] = (field === 'age' ? parseInt(value) : value);
            }
            updateDashboard();
        }

        function renderBeneficiaries() {
            const container = document.getElementById('beneficiariesContainer');
            const count = parseInt(document.getElementById('initialBeneficiaries').value) || 5;
            
            while (beneficiaries.length < count) {
                const nextIndex = beneficiaries.length;
                let defaultAge = 25;
                let relation = 'Child';

                if (nextIndex === 0) { defaultAge = 50; relation = "Settlor"; }
                else if (nextIndex === 1) { defaultAge = 48; relation = "Partner"; }
                else if (nextIndex === 2) { defaultAge = 20; relation = "Child"; }
                else if (nextIndex === 3) { defaultAge = 18; relation = "Child"; }
                else if (nextIndex === 4) { defaultAge = 16; relation = "Child"; }
                
                beneficiaries.push({
                    id: Date.now() + nextIndex,
                    name: nextIndex === 0 ? "Settlor" : (nextIndex === 1 ? "Partner" : `Child ${nextIndex - 1}`),
                    relation: relation,
                    age: defaultAge
                });
            }
            while (beneficiaries.length > count) {
                beneficiaries.pop();
            }

            if (beneficiaries.length > 0) {
                 beneficiaries[0].age = parseInt(document.getElementById('settlorAge').value) || 50;
            }

            const title = container.querySelector('h3');
            container.innerHTML = '';
            if (title) container.appendChild(title);

            beneficiaries.forEach((beneficiary, index) => {
                const card = document.createElement('div');
                card.className = 'bg-white p-3 rounded-lg border border-gray-300 shadow-sm space-y-2';

                const isFixed = index < 2 && index < count; 
                const nameInput = `<input type="text" value="${beneficiary.name}" 
                                       class="w-full text-sm p-1.5 border border-gray-300 rounded ${isFixed ? 'bg-gray-100' : ''} focus:ring-1 focus:ring-trust-navy"
                                       onchange="updateBeneficiary(${index}, 'name', this.value)" ${isFixed ? 'readonly' : ''}>`;

                card.innerHTML = `
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="text-xs font-medium text-gray-600">${isFixed ? 'Fixed Name' : 'Name'}</label>
                            ${nameInput}
                        </div>
                        <div>
                            <label class="text-xs font-medium text-gray-600">Relation</label>
                            <select class="w-full text-sm p-1.5 border border-gray-300 rounded focus:ring-1 focus:ring-trust-navy"
                                         onchange="updateBeneficiary(${index}, 'relation', this.value)" ${isFixed ? 'disabled' : ''}>
                                <option value="Settlor" ${beneficiary.relation === 'Settlor' ? 'selected' : ''}>Settlor</option>
                                <option value="Partner" ${beneficiary.relation === 'Partner' ? 'selected' : ''}>Partner</option>
                                <option value="Child" ${beneficiary.relation === 'Child' ? 'selected' : ''}>Child</option>
                                <option value="Other" ${beneficiary.relation === 'Other' ? 'selected' : ''}>Other</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="text-xs font-medium text-gray-600">Age (Years)</label>
                        <input type="number" value="${beneficiary.age}" min="0" max="100"
                               class="w-full text-sm p-1.5 border border-gray-300 rounded ${index === 0 ? 'bg-gray-100' : ''} focus:ring-1 focus:ring-trust-navy"
                               onchange="updateBeneficiary(${index}, 'age', this.value)" ${index === 0 ? 'readonly' : ''}>
                    </div>
                `;
                container.appendChild(card);
            });
            updateDashboard();
        }

        function updateTrustPeriodDisplay() {
            const slider = document.getElementById('trustPeriod');
            const display = document.getElementById('trustPeriodValue');
            const button = document.getElementById('runSimulationBtn');
            const value = slider.value;
            display.textContent = value;
            
            button.textContent = `Run Simulation (${value} Years)`;
            
            const progress = ((value - slider.min) / (slider.max - slider.min)) * 100;
            slider.style.setProperty('--progress', progress + '%');
            
            updateDashboard();
        }

        function initializeCharts() {
            const ctx = document.getElementById('aumChart').getContext('2d');
            if (aumChart) aumChart.destroy();
            aumChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array.from({ length: 101 }, (_, i) => i),
                    datasets: [{
                        label: 'Trust Fund AUM (USD)',
                        data: [],
                        borderColor: '#1e3a8a',
                        backgroundColor: 'rgba(30, 58, 138, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => `AUM: ${formatCurrency(context.parsed.y, false)}`
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'Years' }
                        },
                        y: {
                            title: { display: true, text: 'AUM (USD)' },
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value, true);
                                }
                            }
                        }
                    },
                    animation: {
                        duration: 800,
                        easing: 'easeInOutQuart'
                    }
                }
            });
        }

        function runSimulation() {
            try {
                const inputs = {
                    trustPrincipal: parseCurrency(document.getElementById('trustPrincipal').value),
                    settlorAge: parseInt(document.getElementById('settlorAge').value) || 50,
                    marriageAge: parseInt(document.getElementById('marriageAge').value) || 28,
                    childrenPerFamily: parseInt(document.getElementById('childrenPerFamily').value) || 2,
                    sumAssured: parseCurrency(document.getElementById('sumAssured').value),
                    distributionRate: parseFloat(document.getElementById('distributionRate').value.replace('%', '')) / 100 || 0.2,
                    trustPeriod: parseInt(document.getElementById('trustPeriod').value) || 100
                };

                let AUM = inputs.trustPrincipal;
                const AUM_VALUES = [AUM];
                
                let totalFYC = 0;
                let totalBondCommission = 0;
                let totalMgmtCommission = 0;
                let totalPolicies = 0;
                let totalPremiumCost = 0;
                let totalClaimBenefit = 0;
                let totalDistributedIncome = 0; // This variable needs updating

                let fundDepleted = false;
                let depletionYear = 0;

                // Track couples to avoid duplicate births
                let couples = [];
                let nextCoupleId = 1;
                
                // Initialize people with couple tracking
                let currentPeople = JSON.parse(JSON.stringify(beneficiaries)).map((b, index) => ({
                    ...b,
                    deathAge: 85,
                    isAlive: true,
                    coupleId: (index === 0 || index === 1) ? 0 : null,
                    policyYearsRemaining: (index === 0 || index === 1) ? 0 : PREMIUM_PAYMENT_YEARS,
                }));

                // Initial couple (Settlor + Partner) - won't have more children
                if (currentPeople.length >= 2) {
                    couples.push({
                        id: 0,
                        person1Id: currentPeople[0].id,
                        person2Id: currentPeople[1].id,
                        marriedYear: 0,
                        childrenBorn: 0,
                        lastBirthYear: -1
                    });
                } else if (currentPeople.length === 1) {
                    currentPeople[0].coupleId = 0;
                    couples.push({ id: 0, person1Id: currentPeople[0].id, person2Id: null, marriedYear: 0, childrenBorn: 0, lastBirthYear: -1 });
                }


                // Count initial policies (exclude Settlor and Partner - assuming they're past the policy period or don't get one)
                currentPeople.forEach((p, idx) => {
                    if (p.policyYearsRemaining === PREMIUM_PAYMENT_YEARS) {
                        totalPolicies += 1;
                    }
                });

                let newPersonId = 1000;

                for (let year = 1; year <= inputs.trustPeriod; year++) {
                    const startingAUM = AUM;

                    if (fundDepleted) {
                        AUM_VALUES.push(AUM); 
                        currentPeople = currentPeople.filter(p => p.isAlive);
                        for (let i = 0; i < currentPeople.length; i++) {
                            const p = currentPeople[i]; 
                            p.age += 1;
                            if (p.age >= p.deathAge) { p.isAlive = false; }
                        }
                        continue;
                    }
                    
                    const managementFeeDeduction = startingAUM * 0.03;
                    const grossIncome = startingAUM * GROSS_INCOME_RATE;
                    const netIncomeProfit = grossIncome - managementFeeDeduction;
                    
                    let potentialPremiumPayment = 0;
                    currentPeople.forEach(p => {
                        if (p.isAlive && p.policyYearsRemaining > 0) {
                            potentialPremiumPayment += inputs.sumAssured * SA_TO_PREMIUM_RATIO;
                        }
                    });

                    const potentialDistribution = netIncomeProfit * inputs.distributionRate;
                    const mgmtFeeCommission = startingAUM * MGMT_COMMISSION_RATE;
                    
                    // FIX: Accumulate the distributed income for display
                    totalDistributedIncome += potentialDistribution; 
                    
                    let annualBonusDeduction = 0; 
                    if (year % 5 === 0) {
                        annualBonusDeduction = startingAUM * BOND_COMMISSION_RATE; 
                        totalBondCommission += annualBonusDeduction; 
                    }


                    // Calculate AUM change considering all expenses
                    const totalExpenses = potentialDistribution + potentialPremiumPayment + mgmtFeeCommission + annualBonusDeduction;

                    const aumChangeBeforeClaims = netIncomeProfit - totalExpenses; // Used for depletion check

                    if (startingAUM + aumChangeBeforeClaims <= 0 && startingAUM > 0) {
                         fundDepleted = true;
                         depletionYear = year;
                         AUM = 0;
                         AUM_VALUES.push(0); 
                         continue;
                    } else if (fundDepleted && startingAUM === 0) {
                         AUM_VALUES.push(0); 
                         continue;
                    }

                    // Commission Calculations for WM Income (Annual Management Fee)
                    totalMgmtCommission += mgmtFeeCommission;
                    
                    // CORRECT AUM UPDATE: Deducting Net Profit, Distribution, Premiums, WM Management Fee, AND Bond Bonus
                    AUM = startingAUM + netIncomeProfit - totalExpenses;
                    
                    // Population Dynamics
                    currentPeople = currentPeople.filter(p => p.isAlive);
                    
                    let annualPremiumPayment = 0;
                    let totalClaimReceived = 0;

                    const peopleToProcess = [...currentPeople];

                    for (let i = 0; i < peopleToProcess.length; i++) {
                        const p = peopleToProcess[i];
                        
                        // Aging and Death
                        p.age += 1;
                        if (p.age >= p.deathAge) {
                            p.isAlive = false;
                            totalClaimReceived += inputs.sumAssured;
                            continue;
                        }
                        
                        // Marriage (exclude Settlor)
                        if (p.coupleId === null && p.age === inputs.marriageAge && p.name !== 'Settlor') {
                            const partner = {
                                id: newPersonId++,
                                name: `Partner of ${p.name}`,
                                age: inputs.marriageAge,
                                deathAge: 85,
                                isAlive: true,
                                coupleId: nextCoupleId,
                                policyYearsRemaining: PREMIUM_PAYMENT_YEARS,
                            };
                            
                            p.coupleId = nextCoupleId;
                            
                            couples.push({
                                id: nextCoupleId,
                                person1Id: p.id,
                                person2Id: partner.id,
                                marriedYear: year,
                                childrenBorn: 0,
                                lastBirthYear: -1
                            });
                            
                            currentPeople.push(partner);
                            totalPolicies += 1;
                            nextCoupleId++;
                        }
                        
                        // Policy Premium & Commission Tracking
                        if (p.policyYearsRemaining > 0) {
                            const annualPremium = inputs.sumAssured * SA_TO_PREMIUM_RATIO;
                            annualPremiumPayment += annualPremium;
                            
                            if (p.policyYearsRemaining === PREMIUM_PAYMENT_YEARS) {
                                const fyc = annualPremium * FYC_RATIO;
                                totalFYC += fyc;
                            }
                            p.policyYearsRemaining -= 1;
                        }
                    }
                    
                    // Birth of Children (per COUPLE, not per person)
                    couples.forEach(couple => {
                        if (couple.childrenBorn < inputs.childrenPerFamily && couple.marriedYear > 0) {
                            const yearsSinceMarriage = year - couple.marriedYear;
                            const yearsSinceLastBirth = year - couple.lastBirthYear;
                            
                            if ((couple.childrenBorn === 0 && yearsSinceMarriage === 1) ||
                                (couple.childrenBorn > 0 && yearsSinceLastBirth === 2)) {
                                
                                couple.childrenBorn++;
                                couple.lastBirthYear = year;
                                
                                const parent = currentPeople.find(p => p.id === couple.person1Id);
                                
                                currentPeople.push({
                                    id: newPersonId++,
                                    name: `Child ${couple.childrenBorn} of ${parent ? parent.name : 'Unknown'}`,
                                    age: 0,
                                    deathAge: 85,
                                    isAlive: true,
                                    coupleId: null,
                                    policyYearsRemaining: PREMIUM_PAYMENT_YEARS,
                                });
                                totalPolicies += 1;
                            }
                        }
                    });
                    
                    // AUM Update for Claims/Premiums
                    AUM += totalClaimReceived;
                    totalClaimBenefit += totalClaimReceived;
                    totalPremiumCost += annualPremiumPayment;
                    
                    AUM_VALUES.push(Math.max(0, AUM));
                }

                return {
                    AUM_VALUES,
                    totalFYC,
                    totalBondCommission,
                    totalMgmtCommission,
                    totalPolicies,
                    totalPremiumCost,
                    totalClaimBenefit,
                    totalDistributedIncome,
                    finalBeneficiaryCount: currentPeople.filter(p => p.isAlive).length,
                    fundDepleted,
                    depletionYear
                };

            } catch (error) {
                console.error("Simulation Error:", error);
                // Note: The original code used alert(), which is forbidden. Keeping the console error for debugging.
                const initialPrincipal = parseCurrency(document.getElementById('trustPrincipal')?.value || '$5,000,000');
                return { 
                    AUM_VALUES: [initialPrincipal], 
                    totalFYC: 0, 
                    totalBondCommission: 0, 
                    totalMgmtCommission: 0, 
                    totalPolicies: 0, 
                    totalPremiumCost: 0, 
                    totalClaimBenefit: 0, 
                    totalDistributedIncome: 0, 
                    finalBeneficiaryCount: beneficiaries.length, 
                    fundDepleted: true, 
                    depletionYear: 0 
                };
            }
        }

        function updateDashboard() {
            const results = runSimulation();
            
            aumChart.data.labels = Array.from({ length: results.AUM_VALUES.length }, (_, i) => i);
            aumChart.data.datasets[0].data = results.AUM_VALUES;
            aumChart.update();
            
            const totalCommission = results.totalFYC + results.totalBondCommission + results.totalMgmtCommission;
            
            const finalAUM = results.AUM_VALUES[results.AUM_VALUES.length - 1];
            document.getElementById('finalAUMDisplay').textContent = formatCurrency(finalAUM, false);
            document.getElementById('totalDistribution').textContent = formatCurrency(results.totalDistributedIncome, false);

            document.getElementById('totalBeneficiaries').textContent = results.finalBeneficiaryCount;
            document.getElementById('totalCommission').textContent = formatCurrency(totalCommission, false);
            document.getElementById('fycCommission').textContent = formatCurrency(results.totalFYC, false);
            document.getElementById('bondCommission').textContent = formatCurrency(results.totalBondCommission, false);
            document.getElementById('mgmtCommission').textContent = formatCurrency(results.totalMgmtCommission, false);
            document.getElementById('totalPolicies').textContent = results.totalPolicies;
            document.getElementById('totalPremiumCost').textContent = formatCurrency(results.totalPremiumCost, true);
            document.getElementById('totalClaimBenefit').textContent = formatCurrency(results.totalClaimBenefit, true);
            
            const headerElement = document.querySelector('header h1');
            const chartTitleElement = document.getElementById('chartTitle');
            const totalBeneficiariesTitleElement = document.getElementById('totalBeneficiariesTitle');
            const finalAUMTitleElement = document.getElementById('finalAUMTitle');
            const potentialIncomeTitleElement = document.getElementById('potentialIncomeTitle');
            const trustPeriod = parseInt(document.getElementById('trustPeriod').value) || 100;
            
            chartTitleElement.textContent = `📈 Trust Fund AUM Projection (${trustPeriod} Years)`;
            totalBeneficiariesTitleElement.textContent = `Total Beneficiaries After ${trustPeriod} Years`;
            finalAUMTitleElement.textContent = `Final Trust Fund AUM (Year ${trustPeriod})`;
            potentialIncomeTitleElement.textContent = `💰 Potential Income for Wealth Manager (${trustPeriod}-Year Total)`;
            
            if (results.fundDepleted && results.depletionYear > 0) {
                headerElement.innerHTML = `
                    WM Commission and Fund Projections (${trustPeriod}-Year Period)
                    <span class="text-red-600 text-lg font-bold block mt-2">
                        ⚠️ FUND DEPLETED IN YEAR ${results.depletionYear} - Simulation Stopped
                    </span>
                `;
                headerElement.className = 'text-3xl font-extrabold text-gray-900 text-center sm:text-left';
            } else {
                headerElement.innerHTML = `WM Commission and Fund Projections (${trustPeriod}-Year Period)`;
                headerElement.className = 'text-3xl font-extrabold text-gray-900 text-center sm:text-left';
            }
        }

        function formatCurrency(value, compact = false) {
            if (typeof value !== 'number' || isNaN(value)) value = 0;
            const displayValue = value;
            const symbol = '$'; 

            if (compact) {
                if (Math.abs(displayValue) >= 1e12) return `${symbol}${(displayValue / 1e12).toFixed(2)}T`;
                if (Math.abs(displayValue) >= 1e9) return `${symbol}${(displayValue / 1e9).toFixed(2)}B`;
                if (Math.abs(displayValue) >= 1e6) return `${symbol}${(displayValue / 1e6).toFixed(2)}M`;
                if (Math.abs(displayValue) >= 1e3) return `${symbol}${Math.round(displayValue / 1e3)}K`;
                return `${symbol}${displayValue.toLocaleString('en-US', { maximumFractionDigits: 0 })}`;
            }
            return symbol + displayValue.toLocaleString('en-US', { maximumFractionDigits: 0 });
        }
    </script>
</body>
</html>
